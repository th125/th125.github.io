---
layout: post
title: 리눅스 메모리 관리
date: 2019-04-23 01:10:00
---

1. 메모리 관리 기법과 가상 메모리
믈리 메모리의 한계를 극복하기 위해 가상 메모리 기법이 사용됨

2. 물리 메모리 관리 자료구조
SMP: Symmetric Multiprocessing
모든 CPU가 메모리와 입출력 버스등을 공유하는 구조
성능 상 병목 현상이 발생할 수 있음

NUMA: Non-Uniform Memory Access
CPU를 몇개의 그룹으로 나누고 각각의 그룹에게 별도의 지역 메모리를 주는 구조
어떤 메모리를 접근하느냐에 따라 성능의 차이가 발생할 수 있다.

UMA: Uniform Memory Access
NUMA와 반대 개념, 기존 시스템

2-1 Node
뱅크: 접근 속도가 같은 메모리 집합
UMA 구조에서는 한개의 뱅크가 존재
NUMA 구조에서는 여러개의 뱅크가 존재

리눅스에서 뱅크를 표현하는 구조가 노드(~/include/linux/mmzone.h)이다.
UMA 구조의 시스템에서 리눅스가 수행된다면 한개의 노드가 존재, 리눅스의 전역변수 contig_page_data를 통해 접근 가능
NUMA 구조의 시스템에서 리눅스가 수행되면 복수 개의 노드가 존재, pgdat_list 배열을 통해 접근 가능
리눅스는 하드웨어 시스템에 상관없이 노드라는 일관된 자료구조를 통해 전체 물리 메모리를 접근할 수 있음

하나의 노드는 pg_data_t 구조체를 통해 표현됨
node_present_pages: 노드에 속해있는 물리 메모리의 양
node_start_pfn: 해당 물리 메모리가 메모리 맵의 몇번지에 위치하고 있는지를 나타냄
node_zones: zone 구조체를 담기위한 배열
nr_zones: zone의 개수를 담는 변수

리눅스가 물리 메모리의 할당 요청을 받으면 되도록 할당을 요청한 태스크가 수행되고 있는 CPU와 가까운 노드에서 메모리를 할당한다.
리눅스는 태스크가 되도록 이전에 수행되었던 CPU에서 다시 수행되도록 하기 때문에 높은 성능을 얻을 수 있다.

2-2 Zone
Node 안에 존재하는 메모리는 모두 어떠한 용도로도 사용될 수 있어야 한다.
노드의 메모리를 관리하기 위한 용도로 사용
물리 메모리의 시작주소와 크기
버디 할당자가 사용할 free_aread 구조체를 담는 변수
watermark와 vm_stat를 통해 남아있는 빈공간이 부족할 경우 적절한 메모리 해제 정책을 결정

ZONE_DMA: 노드에 존재하는 16MB 이하의 부분을 관리
ZONE_NORMAL: 16MB 이상, 896MB 까지 관리, 가상 주소공간과 1:1로 연결
ZONE_HIGHMEM: 필요할 때 동적으로 연결하여 사용

2-3 Page Frame
물리 메모리의 최소 단위를 페이지 프레임이라고 부른다.
리눅스는 시스템 내의 모든 물리 메모리에 접근 가능해야 한다.
이를 위해 모든 페이지 프레임 당 하나씩 page 구조체가 존재한다.
시스템이 부팅되는 순간에 구축되어 물리 메모리 특정 위치(mem_map)에 저장된다.

복수개의 페이지 프레임이 zone을 구성
하나 혹은 그 이상의 zone이 node를 구성
하나 혹은 그 이상의 node가 존재하는 것이 리눅스의 전체 물리 메모리 관리 구조

